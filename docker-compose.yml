# Docker Compose for local Redis Enterprise testing
#
# Usage:
#   docker compose up -d              # Start Redis Enterprise
#   docker compose up init            # Initialize cluster (run once after first start)
#   docker compose down -v            # Stop and remove
#
# Environment variables (optional):
#   REDIS_ENTERPRISE_IMAGE    - Docker image (default: redislabs/redis:latest)
#   REDIS_ENTERPRISE_PLATFORM - Platform (default: linux/amd64, use linux/arm64 for Apple Silicon)
#
# For Apple Silicon Macs, use:
#   REDIS_ENTERPRISE_IMAGE=kurtfm/rs-arm:latest REDIS_ENTERPRISE_PLATFORM=linux/arm64 docker compose up -d
#
# After initialization:
#   API:      https://localhost:9443 (admin@redis.local / Redis123!)
#   Web UI:   https://localhost:8443
#   Database: localhost:12000

services:
  redis-enterprise:
    image: ${REDIS_ENTERPRISE_IMAGE:-redislabs/redis:latest}
    platform: ${REDIS_ENTERPRISE_PLATFORM:-linux/amd64}
    container_name: redis-enterprise
    tty: true
    cap_add:
      - ALL
    ports:
      - "12000:12000"  # Default database port
      - "9443:9443"    # REST API
      - "8443:8443"    # Admin UI
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:9443/v1/bootstrap"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  init:
    image: curlimages/curl:latest
    container_name: redis-enterprise-init
    depends_on:
      redis-enterprise:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Initializing Redis Enterprise cluster..."

        # Bootstrap the cluster
        curl -sk -X POST https://redis-enterprise:9443/v1/bootstrap/create_cluster \
          -H "Content-Type: application/json" \
          -d '{
            "action": "create_cluster",
            "cluster": {"name": "test-cluster"},
            "node": {"paths": {"persistent_path": "/var/opt/redislabs/persist", "ephemeral_path": "/var/opt/redislabs/tmp"}},
            "credentials": {"username": "admin@redis.local", "password": "Redis123!"}
          }'

        echo ""
        echo "Waiting for cluster to be ready..."
        sleep 5

        # Create a test database
        echo "Creating test database..."
        curl -sk -X POST https://redis-enterprise:9443/v1/bdbs \
          -u "admin@redis.local:Redis123!" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "test-db",
            "memory_size": 104857600,
            "port": 12000,
            "replication": false,
            "data_persistence": "disabled",
            "eviction_policy": "allkeys-lru"
          }'

        echo ""
        echo "============================================"
        echo "Redis Enterprise cluster initialized!"
        echo ""
        echo "API:      https://localhost:9443"
        echo "Web UI:   https://localhost:8443"
        echo "Database: localhost:12000"
        echo ""
        echo "Credentials: admin@redis.local / Redis123!"
        echo "============================================"
    profiles:
      - init
